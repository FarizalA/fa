<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sakura Minimal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --sakura:#FDE2E4;
      --snow:#F9F6F7;
      --sage:#E2ECE9;
      --pistachio:#CDE7BE;
      --cool-grey:#CAD2C5;
    }
    body{
      font-family:'Poppins',sans-serif;
      background:var(--snow);
      color:#333;
      margin:0;
      line-height:1.6;
    }
    header{
      background:var(--sakura);
      padding:0.5rem 1rem;
      text-align:center;
      font-weight:500;
    }
    main{max-width:900px;margin:1rem auto;padding:0 1rem;}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin:1.5rem 0;}
    .kpi-card{background:var(--sage);padding:1rem;border-radius:8px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    form input[type="text"],form input[type="number"],form input[type="date"]{width:100%;padding:0.5rem;border:1px solid var(--cool-grey);border-radius:4px;margin-bottom:0.5rem;background:white;}
    .radio-group{display:flex;gap:1rem;margin:0.5rem 0;}
    .radio-group label{display:flex;align-items:center;gap:0.25rem;}
    button,select{padding:0.5rem 1rem;border:none;border-radius:4px;font-weight:500;cursor:pointer;}
    .btn-primary{background:var(--pistachio);} 
    .btn-secondary{background:var(--sakura);} 
    section{margin:2rem 0;}
    table{width:100%;border-collapse:collapse;margin-top:1rem;}
    th,td{padding:0.5rem;border-bottom:1px solid var(--cool-grey);text-align:left;}
    td.text-right{text-align:right;}
    .badge{padding:0.15rem 0.5rem;border-radius:4px;font-size:0.8rem;}
    .badge.pemasukan{background:var(--pistachio);}
    .badge.pengeluaran{background:var(--sakura);}
    #custom-range{display:none;gap:0.5rem;margin-top:0.5rem;}
  </style>
</head>
<body>
  <header>Halo! Senang bisa bantu mengatur keuanganmu ðŸŒ¸</header>
  <main>
    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card"><h3>Total Pemasukan</h3><p id="total-income">RpÂ 0</p></div>
      <div class="kpi-card"><h3>Total Pengeluaran</h3><p id="total-expense">RpÂ 0</p></div>
      <div class="kpi-card"><h3>Saldo Akhir</h3><p id="balance">RpÂ 0</p></div>
    </div>

    <!-- Form -->
    <section>
      <h2>Transaksi Baru</h2>
      <form id="transaction-form">
        <input id="desc" type="text" placeholder="Contoh: Gaji" required>
        <input id="amount" type="number" placeholder="Nominal" required>
        <div class="radio-group">
          <label><input type="radio" name="type" value="pemasukan" checked>Pemasukan</label>
          <label><input type="radio" name="type" value="pengeluaran">Pengeluaran</label>
        </div>
        <button type="submit" class="btn-primary">Simpan Transaksi</button>
      </form>
    </section>

    <!-- Analysis -->
    <section>
      <h2>Analisis & Wawasan</h2>
      <p id="insight">Belum ada transaksi.</p>
      <button id="ai-btn" class="btn-secondary">Dapatkan Analisis AI Lengkap</button>
    </section>

    <!-- Filter & Chart -->
    <section>
      <h2>Periode</h2>
      <label for="date-filter">Filter tanggal:</label>
      <select id="date-filter">
        <option value="daily">Harian</option>
        <option value="weekly">Mingguan</option>
        <option value="monthly">Bulanan</option>
        <option value="custom">Custom</option>
      </select>
      <div id="custom-range">
        <input type="date" id="start-date">
        <input type="date" id="end-date">
        <button id="apply-range" class="btn-primary">Terapkan</button>
      </div>
      <canvas id="chart" height="120"></canvas>
    </section>

    <!-- Export -->
    <section>
      <label for="export-select">Ekspor Laporan:</label>
      <select id="export-select">
        <option value="">Pilih format</option>
        <option value="csv">CSV</option>
        <option value="xlsx">XLSX</option>
        <option value="pdf">PDF</option>
      </select>
    </section>

    <!-- History Table -->
    <section>
      <h2>Riwayat Transaksi</h2>
      <table>
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Deskripsi</th>
            <th>Pemasukan</th>
            <th>Pengeluaran</th>
            <th>Jenis</th>
          </tr>
        </thead>
        <tbody id="history-body"></tbody>
      </table>
    </section>
  </main>

  <script>
    const transactions = [];
    const form = document.getElementById('transaction-form');
    const insightEl = document.getElementById('insight');
    const dateFilter = document.getElementById('date-filter');
    const customRange = document.getElementById('custom-range');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const exportSelect = document.getElementById('export-select');
    let chart;

    form.addEventListener('submit', addTransaction);
    dateFilter.addEventListener('change', () => {
      customRange.style.display = dateFilter.value === 'custom' ? 'flex' : 'none';
      if(dateFilter.value !== 'custom') updateChart();
    });
    document.getElementById('apply-range').addEventListener('click', updateChart);
    document.getElementById('ai-btn').addEventListener('click', () => alert('Fitur analisis AI belum tersedia.'));
    exportSelect.addEventListener('change', e => { if(e.target.value){ exportReport(e.target.value); e.target.value=''; } });

    function addTransaction(e){
      e.preventDefault();
      const desc = document.getElementById('desc').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const type = document.querySelector('input[name="type"]:checked').value;
      if(!desc || isNaN(amount)) return;
      transactions.push({date:new Date(), desc, amount, type});
      form.reset();
      updateAll();
    }

    function updateAll(){
      updateSummary();
      renderTable();
      updateChart();
      generateInsight();
    }

    function updateSummary(){
      let income=0, expense=0;
      transactions.forEach(t=>{
        if(t.type==='pemasukan') income+=t.amount; else expense+=t.amount;
      });
      document.getElementById('total-income').textContent = formatRupiah(income);
      document.getElementById('total-expense').textContent = formatRupiah(expense);
      document.getElementById('balance').textContent = formatRupiah(income-expense);
    }

    function renderTable(){
      const tbody = document.getElementById('history-body');
      tbody.innerHTML='';
      transactions.slice().reverse().forEach(t=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${t.date.toLocaleDateString('id-ID')}</td>
                      <td>${t.desc}</td>
                      <td class="text-right">${t.type==='pemasukan'?formatRupiah(t.amount):''}</td>
                      <td class="text-right">${t.type==='pengeluaran'?formatRupiah(t.amount):''}</td>
                      <td><span class="badge ${t.type}">${t.type==='pemasukan'?'Pemasukan':'Pengeluaran'}</span></td>`;
        tbody.appendChild(tr);
      });
    }

    function generateInsight(){
      if(transactions.length===0){ insightEl.textContent='Belum ada transaksi.'; return; }
      const income = transactions.filter(t=>t.type==='pemasukan').reduce((s,t)=>s+t.amount,0);
      const expense = transactions.filter(t=>t.type==='pengeluaran').reduce((s,t)=>s+t.amount,0);
      const balance = income-expense;
      insightEl.textContent = `Total transaksi: ${transactions.length}. Saldo akhir ${balance>=0?'surplus':'defisit'} ${formatRupiah(Math.abs(balance))}.`;
    }

    function updateChart(){
      const filter = dateFilter.value;
      const map = {};
      const addData=(key,type,amt)=>{ if(!map[key]) map[key]={income:0,expense:0}; map[key][type]+=amt; };
      transactions.forEach(t=>{
        const d=new Date(t.date);
        let key;
        if(filter==='daily') key=d.toISOString().slice(0,10);
        else if(filter==='weekly') key=weekKey(d);
        else if(filter==='monthly') key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        else if(filter==='custom'){
          if(!startDate.value||!endDate.value) return;
          const s=new Date(startDate.value); const e=new Date(endDate.value); e.setHours(23,59,59,999);
          if(d<s||d>e) return; key=d.toISOString().slice(0,10);
        }
        addData(key, t.type==='pemasukan'?'income':'expense', t.amount);
      });
      const labels=Object.keys(map).sort();
      const incomeData=labels.map(l=>map[l].income);
      const expenseData=labels.map(l=>map[l].expense);
      const ctx=document.getElementById('chart').getContext('2d');
      if(chart) chart.destroy();
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Pemasukan',data:incomeData,fill:true,backgroundColor:'rgba(205,231,190,0.4)',borderColor:'#CDE7BE',tension:0.4},{label:'Pengeluaran',data:expenseData,fill:true,backgroundColor:'rgba(253,226,228,0.4)',borderColor:'#FDE2E4',tension:0.4}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
    }

    function weekKey(d){
      const firstJan=new Date(d.getFullYear(),0,1);
      const day=Math.floor((d-firstJan)/86400000)+firstJan.getDay();
      const week=Math.ceil(day/7);
      return `${d.getFullYear()}-W${week}`;
    }

    function formatRupiah(num){
      return num.toLocaleString('id-ID',{style:'currency',currency:'IDR'});
    }

    function exportReport(type){
      if(transactions.length===0){alert('Belum ada data.');return;}
      if(type==='csv') exportCSV();
      if(type==='xlsx') exportXLSX();
      if(type==='pdf') exportPDF();
    }

    function exportCSV(){
      const rows=[['Tanggal','Deskripsi','Pemasukan','Pengeluaran','Jenis']];
      transactions.forEach(t=>rows.push([t.date.toLocaleDateString('id-ID'),t.desc,t.type==='pemasukan'?t.amount:'',t.type==='pengeluaran'?t.amount:'',t.type]));
      let csv=rows.map(r=>r.join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download='laporan.csv';
      link.click();
    }

    function exportXLSX(){
      const wb=XLSX.utils.book_new();
      const ws_data=[['Tanggal','Deskripsi','Pemasukan','Pengeluaran','Jenis']];
      transactions.forEach(t=>ws_data.push([t.date.toLocaleDateString('id-ID'),t.desc,t.type==='pemasukan'?t.amount:'',t.type==='pengeluaran'?t.amount:'',t.type]));
      const ws=XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb,ws,'Laporan');
      XLSX.writeFile(wb,'laporan.xlsx');
    }

    function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF();
      const rows=transactions.map(t=>[t.date.toLocaleDateString('id-ID'),t.desc,t.type==='pemasukan'?formatRupiah(t.amount):'',t.type==='pengeluaran'?formatRupiah(t.amount):'',t.type]);
      doc.autoTable({head:[['Tanggal','Deskripsi','Pemasukan','Pengeluaran','Jenis']],body:rows});
      doc.save('laporan.pdf');
    }
  </script>
</body>
</html>
