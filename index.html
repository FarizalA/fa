<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Ku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ol { margin-left: 1.5rem; list-style-type: decimal; }
        .prose li { margin-bottom: 0.25rem; }
        .spinner, .table-spinner { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .deleting { opacity: 0.5; pointer-events: none; }

        /* --- Gaya Scrollbar Transparan --- */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.3); /* Abu-abu semi-transparan */
            border-radius: 20px;
            border: 3px solid transparent;
            background-clip: content-box;
        }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5); /* Lebih terlihat saat di-hover */
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        
        <header class="relative text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Catatan Ku</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Hay Selamat Datang</p>
            <!-- Tombol Dark Mode Toggle -->
            <div class="absolute top-0 right-0">
                <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </header>

        <main>
            <!-- Ringkasan Saldo (Keseluruhan) -->
            <section id="saldo-section" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Ringkasan Keuangan (Total)</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg">
                        <p class="text-sm text-green-700 dark:text-green-300 font-medium">Total Pemasukan</p>
                        <p id="total-pemasukan" class="text-2xl font-bold text-green-800 dark:text-green-200">Rp 0</p>
                    </div>
                    <div class="bg-red-100 dark:bg-red-900/50 p-4 rounded-lg">
                        <p class="text-sm text-red-700 dark:text-red-300 font-medium">Total Pengeluaran</p>
                        <p id="total-pengeluaran" class="text-2xl font-bold text-red-800 dark:text-red-200">Rp 0</p>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-900/50 p-4 rounded-lg">
                        <p class="text-sm text-blue-700 dark:text-blue-300 font-medium">Saldo Akhir</p>
                        <p id="saldo-akhir" class="text-2xl font-bold text-blue-800 dark:text-blue-200">Rp 0</p>
                    </div>
                </div>
            </section>
            
            <!-- Form dan Analisis AI -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Form Input Transaksi -->
                <section id="form-section" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Tambah Transaksi Baru</h2>
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="deskripsi" class="block text-sm font-medium text-gray-600 dark:text-gray-400">Deskripsi</label>
                            <input type="text" id="deskripsi" placeholder="Contoh: Penjualan produk A" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-900 dark:text-gray-200" required>
                        </div>
                        <div>
                            <label for="nominal" class="block text-sm font-medium text-gray-600 dark:text-gray-400">Nominal (Rp)</label>
                            <input type="number" id="nominal" placeholder="Contoh: 50000" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-900 dark:text-gray-200" required>
                        </div>
                        <div>
                            <label for="jenis" class="block text-sm font-medium text-gray-600 dark:text-gray-400">Jenis Transaksi</label>
                            <select id="jenis" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-900 dark:text-gray-200">
                                <option value="pemasukan">Pemasukan</option>
                                <option value="pengeluaran">Pengeluaran</option>
                            </select>
                        </div>
                        <div class="text-right">
                            <button type="submit" id="submit-btn" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                Simpan Transaksi
                            </button>
                        </div>
                    </form>
                </section>
                <!-- Analisis AI -->
                <section id="ai-analysis-section" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Analisis Keuangan Cerdas âœ¨</h2>
                    <div id="ai-result-container" class="bg-indigo-50 dark:bg-gray-700/50 p-4 rounded-lg min-h-[150px] prose max-w-none dark:text-gray-300">Klik tombol untuk mendapatkan analisis dari AI.</div>
                    <div id="ai-error-message" class="hidden bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 p-4 rounded-lg my-4"></div>
                    <div class="text-center mt-4">
                        <button id="get-analysis-btn" class="inline-flex items-center justify-center py-2 px-5 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                            <span id="btn-text">Dapatkan Analisis</span>
                            <div id="ai-loading-spinner" class="hidden spinner w-5 h-5 border-4 border-white rounded-full ml-2"></div>
                        </button>
                    </div>
                </section>
            </div>

            <!-- Riwayat Transaksi Hari Ini -->
            <section id="history-section-today" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Riwayat Transaksi Hari Ini</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kolom Pemasukan Hari Ini -->
                    <div>
                        <h3 class="text-lg font-medium text-green-700 dark:text-green-400 mb-3">Pemasukan</h3>
                        <div class="overflow-y-auto max-h-64 border border-gray-200 dark:border-gray-700 rounded-lg custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tanggal</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Deskripsi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nominal</th>
                                        <th class="relative px-4 py-2"><span class="sr-only">Hapus</span></th>
                                    </tr>
                                </thead>
                                <tbody id="pemasukan-list-today" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Kolom Pengeluaran Hari Ini -->
                    <div>
                        <h3 class="text-lg font-medium text-red-700 dark:text-red-400 mb-3">Pengeluaran</h3>
                        <div class="overflow-y-auto max-h-64 border border-gray-200 dark:border-gray-700 rounded-lg custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tanggal</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Deskripsi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nominal</th>
                                        <th class="relative px-4 py-2"><span class="sr-only">Hapus</span></th>
                                    </tr>
                                </thead>
                                <tbody id="pengeluaran-list-today" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Semua Riwayat Transaksi -->
            <section id="history-section-all" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Semua Riwayat Transaksi</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kolom Semua Pemasukan -->
                    <div>
                        <h3 class="text-lg font-medium text-green-700 dark:text-green-400 mb-3">Pemasukan</h3>
                        <div class="overflow-y-auto max-h-80 border border-gray-200 dark:border-gray-700 rounded-lg custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tanggal</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Deskripsi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nominal</th>
                                        <th class="relative px-4 py-2"><span class="sr-only">Hapus</span></th>
                                    </tr>
                                </thead>
                                <tbody id="pemasukan-list-all" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Kolom Semua Pengeluaran -->
                    <div>
                        <h3 class="text-lg font-medium text-red-700 dark:text-red-400 mb-3">Pengeluaran</h3>
                        <div class="overflow-y-auto max-h-80 border border-gray-200 dark:border-gray-700 rounded-lg custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tanggal</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Deskripsi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nominal</th>
                                        <th class="relative px-4 py-2"><span class="sr-only">Hapus</span></th>
                                    </tr>
                                </thead>
                                <tbody id="pengeluaran-list-all" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- DARK MODE SCRIPT ---
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleDarkIcon.classList.remove('hidden');
        }

        const themeToggleBtn = document.getElementById('theme-toggle');

        themeToggleBtn.addEventListener('click', function() {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });

        // --- APPLICATION SCRIPT ---
        const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxorfRq7bYC5rtP1e3yZZPpvzPtpXuTqrJ47COBAQaQV6tMDk5XDJ97aK5qEB2ZbuCJ/exec';
        
        const transactionForm = document.getElementById('transaction-form');
        const submitBtn = document.getElementById('submit-btn');
        const totalPemasukanEl = document.getElementById('total-pemasukan');
        const totalPengeluaranEl = document.getElementById('total-pengeluaran');
        const saldoAkhirEl = document.getElementById('saldo-akhir');
        
        const pemasukanListTodayEl = document.getElementById('pemasukan-list-today');
        const pengeluaranListTodayEl = document.getElementById('pengeluaran-list-today');
        const pemasukanListAllEl = document.getElementById('pemasukan-list-all');
        const pengeluaranListAllEl = document.getElementById('pengeluaran-list-all');

        const getAnalysisBtn = document.getElementById('get-analysis-btn');
        const aiResultContainer = document.getElementById('ai-result-container');
        const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
        const btnText = document.getElementById('btn-text');
        const aiErrorMessage = document.getElementById('ai-error-message');
        
        let allTransactions = [];

        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        }

        function formatTanggal(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const options = { day: '2-digit', month: 'short', year: '2-digit' };
            return date.toLocaleDateString('id-ID', options).replace(/\./g, '');
        }

        function showTableLoading(tbody) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4"><div class="flex justify-center items-center text-sm text-gray-500 dark:text-gray-400"><div class="table-spinner w-4 h-4 border-2 border-gray-300 rounded-full mr-2"></div>Memuat...</div></td></tr>`;
        }

        function populateTable(tbodyEl, data, jenis, emptyMessage) {
            tbodyEl.innerHTML = '';
            if (data.length === 0) {
                tbodyEl.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-400">${emptyMessage}</td></tr>`;
                return;
            }

            const sortedData = [...data].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            sortedData.forEach(transaction => {
                const row = document.createElement('tr');
                row.id = `trx-${transaction.id}`;
                const isPemasukan = transaction.jenis === 'pemasukan';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatTanggal(transaction.tanggal)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${transaction.deskripsi}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${isPemasukan ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${formatRupiah(transaction.nominal)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteTransaction('${transaction.id}', '${transaction.jenis}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">Hapus</button>
                    </td>
                `;
                tbodyEl.appendChild(row);
            });
        }

        function renderTransactions() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTransactions = allTransactions.filter(t => {
                const transactionDate = new Date(t.tanggal);
                transactionDate.setHours(0, 0, 0, 0);
                return transactionDate.getTime() === today.getTime();
            });
            const pemasukanHariIni = todayTransactions.filter(t => t.jenis === 'pemasukan');
            const pengeluaranHariIni = todayTransactions.filter(t => t.jenis === 'pengeluaran');
            populateTable(pemasukanListTodayEl, pemasukanHariIni, 'pemasukan', 'Tidak ada pemasukan hari ini.');
            populateTable(pengeluaranListTodayEl, pengeluaranHariIni, 'pengeluaran', 'Tidak ada pengeluaran hari ini.');

            const semuaPemasukan = allTransactions.filter(t => t.jenis === 'pemasukan');
            const semuaPengeluaran = allTransactions.filter(t => t.jenis === 'pengeluaran');
            populateTable(pemasukanListAllEl, semuaPemasukan, 'pemasukan', 'Belum ada riwayat pemasukan.');
            populateTable(pengeluaranListAllEl, semuaPengeluaran, 'pengeluaran', 'Belum ada riwayat pengeluaran.');
        }

        function updateSummary() {
            const pemasukan = allTransactions.filter(t => t.jenis === 'pemasukan').reduce((acc, t) => acc + t.nominal, 0);
            const pengeluaran = allTransactions.filter(t => t.jenis === 'pengeluaran').reduce((acc, t) => acc + t.nominal, 0);
            const saldo = pemasukan - pengeluaran;
            totalPemasukanEl.textContent = formatRupiah(pemasukan);
            totalPengeluaranEl.textContent = formatRupiah(pengeluaran);
            saldoAkhirEl.textContent = formatRupiah(saldo);
        }

        async function fetchTransactions() {
            showTableLoading(pemasukanListTodayEl);
            showTableLoading(pengeluaranListTodayEl);
            showTableLoading(pemasukanListAllEl);
            showTableLoading(pengeluaranListAllEl);
            try {
                const response = await fetch(GOOGLE_SHEET_API_URL);
                if (!response.ok) throw new Error('Gagal mengambil data dari Google Sheets.');
                allTransactions = await response.json();
                renderTransactions();
                updateSummary();
            } catch (error) {
                const errorHtml = `<tr><td colspan="4" class="text-center p-4 text-red-600 text-sm">${error.message}</td></tr>`;
                pemasukanListTodayEl.innerHTML = errorHtml;
                pengeluaranListTodayEl.innerHTML = errorHtml;
                pemasukanListAllEl.innerHTML = errorHtml;
                pengeluaranListAllEl.innerHTML = errorHtml;
            }
        }

        async function addTransaction(e) {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';

            const newTransaction = {
                action: 'add',
                deskripsi: document.getElementById('deskripsi').value,
                nominal: parseFloat(document.getElementById('nominal').value),
                jenis: document.getElementById('jenis').value
            };

            try {
                await fetch(GOOGLE_SHEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(newTransaction),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                await new Promise(resolve => setTimeout(resolve, 1500));
                await fetchTransactions();
                transactionForm.reset();
            } catch (error) {
                alert(`Gagal menyimpan: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Transaksi';
            }
        }

        async function deleteTransaction(id, jenis) {
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) return;
            
            const row = document.getElementById(`trx-${id}`);
            row.classList.add('deleting');
            try {
                await fetch(GOOGLE_SHEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'delete', id: id, jenis: jenis }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                await new Promise(resolve => setTimeout(resolve, 1500));
                await fetchTransactions();
            } catch (error) {
                alert(`Gagal menghapus: ${error.message}`);
                row.classList.remove('deleting');
            }
        }
        
        async function getAiAnalysis() {
            const apiKey = "AIzaSyA_KGVm0tVRGc6hG9rZmvvBpjRZnXfhP_Y";

            aiErrorMessage.classList.add('hidden');
            
            if (allTransactions.length < 3) {
                aiResultContainer.innerHTML = 'Mohon miliki minimal 3 transaksi (total) untuk analisis.';
                return;
            }

            getAnalysisBtn.disabled = true;
            aiLoadingSpinner.classList.remove('hidden');
            btnText.textContent = 'Menganalisis...';
            
            const formattedTransactions = allTransactions.map(t => `- ${t.jenis}: ${t.deskripsi} (${formatRupiah(t.nominal)})`).join('\n');
            const prompt = `Kamu adalah Xyli Asisten AI yang cerdas, ramah, dan serba bisa dari farizaladha. Anggap dirimu sebagai teman ngobrol yang asyik dan punya banyak pengetahuan. Kepribadian Anda suportif, dan sedikit edukatif. Fungsi utama Anda adalah konsultan bisnis. Berdasarkan data transaksi ini:\n${formattedTransactions}\n\nBerikan:\n1. Analisis singkat kondisi keuangan (maks 2 kalimat).\n2. Tiga (3) tips konkret dalam format daftar bernomor untuk meningkatkan usaha.\nSampaikan dengan bahasa yang santai dan mudah dipahami. Jangan gunakan markdown tebal atau miring.`;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Permintaan API gagal.`);
                
                const result = await response.json();
                
                if (result.candidates && result.candidates[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    aiResultContainer.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                    throw new Error("Respons dari AI tidak valid.");
                }

            } catch (error) {
                aiErrorMessage.textContent = "Maaf, terjadi kesalahan saat menghubungi AI: " + error.message;
                aiErrorMessage.classList.remove('hidden');
            } finally {
                getAnalysisBtn.disabled = false;
                aiLoadingSpinner.classList.add('hidden');
                btnText.textContent = 'Dapatkan Analisis';
            }
        }
        
        document.addEventListener('DOMContentLoaded', fetchTransactions);
        transactionForm.addEventListener('submit', addTransaction);
        getAnalysisBtn.addEventListener('click', getAiAnalysis);
    </script>
</body>
</html>
